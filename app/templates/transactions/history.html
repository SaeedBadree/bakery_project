{% extends "base.html" %}

{% block title %}Transaction History - Bakery POS{% endblock %}

{% block content %}
<div class="flex-between mb-2">
    <h1>üí≥ Transaction History</h1>
</div>

<div class="card">
    <form method="get" action="/transactions/history" class="flex gap-2 mb-2">
        <div class="form-group" style="flex: 1;">
            <label for="start_date">Start Date</label>
            <input type="date" id="start_date" name="start_date" value="{{ start_date or '' }}" class="form-control">
        </div>
        <div class="form-group" style="flex: 1;">
            <label for="end_date">End Date</label>
            <input type="date" id="end_date" name="end_date" value="{{ end_date or '' }}" class="form-control">
        </div>
        <div style="display: flex; align-items: flex-end;">
            <button type="submit" class="btn btn-primary">Filter</button>
            <a href="/transactions/history" class="btn btn-secondary" style="margin-left: 0.5rem;">Clear</a>
        </div>
    </form>
    
    {% if transactions %}
    <div style="margin-bottom: 1rem;">
        <strong>Total Transactions:</strong> {{ transactions|length }} | 
        <strong>Total Amount:</strong> ${{ "%.2f"|format(total_amount) }}
    </div>
    
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Sale #</th>
                    <th>Date & Time</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Subtotal</th>
                    <th>Tax</th>
                    <th>Total</th>
                    <th>Payment</th>
                    <th>Cashier</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for sale in transactions %}
                <tr {% if sale.status.value == 'voided' %}style="background-color: #fee; text-decoration: line-through;"{% endif %}>
                    <td><strong>{{ sale.sale_number }}</strong></td>
                    <td>{{ sale.datetime.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ sale.customer.name if sale.customer else 'Walk-in' }}</td>
                    <td>{{ sale.sale_lines|length }}</td>
                    <td>${{ "%.2f"|format(sale.subtotal) }}</td>
                    <td>${{ "%.2f"|format(sale.tax_amount) }}</td>
                    <td><strong>${{ "%.2f"|format(sale.total) }}</strong></td>
                    <td>
                        {% if sale.tender_type.value == 'cash' %}üíµ Cash
                        {% elif sale.tender_type.value == 'card' %}üí≥ Card
                        {% elif sale.tender_type.value == 'transfer' %}üì± Transfer
                        {% elif sale.tender_type.value == 'on_account' %}üìù Account
                        {% endif %}
                    </td>
                    <td>{{ sale.cashier.username }}</td>
                    <td>
                        <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                            <a href="/pos/receipt/{{ sale.id }}" class="btn btn-secondary btn-sm" target="_blank">üìÑ View</a>
                            {% if user.role.name == 'admin' and sale.status.value != 'voided' %}
                            <button onclick="voidTransaction({{ sale.id }}, '{{ sale.sale_number }}')" class="btn btn-danger btn-sm">‚ùå Void</button>
                            {% endif %}
                            {% if sale.status.value == 'voided' %}
                            <span style="color: #e74c3c; font-weight: 600;">VOIDED</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        No transactions found for the selected date range.
    </div>
    {% endif %}
</div>

<script>
function voidTransaction(saleId, saleNumber) {
    if (confirm(`Are you sure you want to VOID transaction ${saleNumber}?\n\nThis action cannot be undone and will:\n- Mark the transaction as voided\n- Reverse inventory changes\n- Keep the record for audit purposes`)) {
        fetch(`/transactions/void/${saleId}`, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                alert('Transaction voided successfully');
                window.location.reload();
            } else {
                return response.text().then(text => {
                    alert('Error voiding transaction: ' + text);
                });
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
}
</script>

<style>
.table {
    font-size: 0.9rem;
}

.table th {
    white-space: nowrap;
}

.table td {
    vertical-align: middle;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8rem;
}
</style>
{% endblock %}

